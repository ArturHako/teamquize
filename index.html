<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<title>Holiday Scene</title>
	<style>
		:root {
			color-scheme: light dark;
		}
		* {
			box-sizing: border-box;
		}
		body {
			margin: 0;
			min-height: 100vh;
			background: #000;
			font-family: "Segoe UI", system-ui, -apple-system, sans-serif;
		}
		.scene {
			position: relative;
			min-height: 100vh;
			width: 100%;
			overflow: hidden;
		}
		.scene__bg {
			position: absolute;
			inset: 0;
			width: 100%;
			height: 100%;
			object-fit: cover;
		}
		.tree-star-hotspot {
			position: absolute;
			top: var(--star-top, 20%);
			left: var(--star-left, 73.5%);
			transform: translate(-50%, -50%);
			width: clamp(42px, 7vw, 60px);
			aspect-ratio: 1;
			border: none;
			border-radius: 50%;
			background: radial-gradient(circle, rgba(255, 255, 255, 0.2), rgba(255, 215, 0, 0.1));
			cursor: pointer;
			box-shadow: 0 0 25px rgba(255, 215, 0, 0.35);
			transition: box-shadow 0.2s ease;
			z-index: 1;
		}
		.tree-star-hotspot::after {
			content: "Ô±ÕµÕ½ Õ¿Õ¡Ö€Õ« Õ´Õ«Õ¡Õ½Õ¶Õ¡Õ¯Õ¡Õ¶ Õ¸Ö‚ÕªÕ¥Ö€Õ¸Õ¾ Õ¯Õ¾Õ¡Õ¼Õ¥Õ¶Ö„ Õ¿Õ¸Õ¶Õ¡Õ®Õ¡Õ¼Õ« Õ¬Õ¸Ö‚ÕµÕ½Õ¥Ö€Õ¨";
			position: absolute;
			left: 50%;
			bottom: 110%;
			transform: translate(-50%, 0) scale(0.9);
			transform-origin: bottom center;
			padding: 0.5rem 0.85rem;
			background: rgba(0, 0, 0, 0.75);
			color: #fff;
			border-radius: 10px;
			font-size: 0.95rem;
			white-space: nowrap;
			opacity: 0;
			pointer-events: none;
			transition: opacity 0.2s ease, transform 0.2s ease;
		}
		.tree-star-hotspot:hover,
		.tree-star-hotspot:focus-visible {
			box-shadow: 0 0 40px rgba(255, 215, 0, 0.55);
			outline: 0px solid rgba(255, 215, 0, 0.4);
		}
		.tree-star-hotspot:hover::after,
		.tree-star-hotspot:focus-visible::after {
			opacity: 0.9;
			transform: translate(-50%, 0) scale(1);
		}
		.tree-star-hotspot.needs-audio {
			animation: star-pulse 1s ease-in-out infinite alternate;
		}
		.tree-toy {
			position: absolute;
			top: var(--toy-top, 80%);
			left: var(--toy-left, 35%);
			transform: translate(-50%, -50%);
			width: var(--toy-size, clamp(60px, 8vw, 110px));
			will-change: transform;
			isolation: isolate;
			z-index: 0;
			--toy-glow-color-rgb: 255, 240, 184;
			--toy-glow-color-mid-rgb: 255, 159, 75;
			--toy-glow-strength: 0.45;
		}
		.tree-toy__glow {
			position: absolute;
			top: 45%;
			left: 50%;
			width: 165%;
			aspect-ratio: 1;
			transform: translate(-50%, -50%);
			border-radius: 50%;
			background: radial-gradient(circle, rgba(var(--toy-glow-color-rgb), 0.9) 0%, rgba(var(--toy-glow-color-mid-rgb), 0.35) 35%, transparent 70%);
			filter: blur(14px);
			opacity: var(--toy-glow-strength);
			mix-blend-mode: screen;
			pointer-events: none;
			animation: toy-glow 3.2s ease-in-out infinite alternate;
			z-index: -1;
		}
		.tree-toy::before {
			content: attr(data-hover-text);
			position: absolute;
			bottom: 80%;
			left: 50%;
			transform: translate(-50%, 10%) scale(0.95);
			padding: 0.45rem 0.9rem;
			border-radius: 9px;
			background: linear-gradient(135deg, rgba(255, 255, 255, 0.9), rgba(255, 215, 150, 0.85));
			color: #1a2750;
			font-size: 0.85rem;
			font-weight: 600;
			letter-spacing: 0.01em;
			box-shadow: 0 12px 25px rgba(0, 0, 0, 0.35);
			backdrop-filter: blur(6px);
			opacity: 0;
			pointer-events: none;
			transition: opacity 0.2s ease, transform 0.2s ease;
			white-space: normal;
			width: 320px;
			text-align: center;
			z-index: 2;
		}
		.tree-toy:is(:hover, :focus-visible) {
			z-index: 5;
		}
		.tree-toy:is(:hover, :focus-visible)::before {
			opacity: 1;
			transform: translate(-50%, -10%) scale(1);
			animation: toy-toast-pop 0.4s ease forwards;
		}
		.tree-toy img {
			display: block;
			width: 100%;
			height: auto;
			transform-origin: top center;
			filter: brightness(var(--toy-brightness, 1)) drop-shadow(0 30px 12px rgba(0, 0, 0, 0.45));
			transition: filter 0.25s ease;
			pointer-events: none;
		}
		.tree-toy:is(:hover, :focus-visible) img {
			--toy-brightness: 1.55;
		}
		@keyframes star-pulse {
			from { transform: translate(-50%, -50%) scale(1); }
			to { transform: translate(-50%, -50%) scale(1.08); }
		}
		@keyframes toy-glow {
			from { filter: blur(12px); }
			to { filter: blur(18px); }
		}
		@keyframes toy-toast-pop {
			from { filter: blur(4px); opacity: 0; transform: translate(-50%, 20%) scale(0.9); }
			to { filter: blur(0); opacity: 1; transform: translate(-50%, -10%) scale(1); }
		}
		.progress {
			position: absolute;
			top: clamp(18px, 1vw, 46px);
			left: clamp(18px, 1vw, 64px);
			right: auto;
			transform: none;
			width: min(460px, 88vw);
			display: flex;
			align-items: center;
			gap: 1rem;
			padding: 0.85rem 1.25rem;
			border-radius: 999px;
			background: rgba(6, 18, 41, 0.9);
			backdrop-filter: blur(12px);
			box-shadow: 0 25px 45px rgba(0, 0, 0, 0.55);
			z-index: 1;
		}
		.progress__track {
			position: relative;
			flex: 1;
			height: 14px;
			border-radius: 999px;
			background:
				linear-gradient(90deg, rgba(255, 255, 255, 0.18), rgba(255, 255, 255, 0.05)),
				repeating-linear-gradient(
					90deg,
					transparent 0 calc((100% / 12) - 1px),
					rgba(255, 255, 255, 0.35) calc((100% / 12) - 1px) calc(100% / 12)
				);
		}
		.progress__track::after {
			content: "";
			position: absolute;
			inset: -6px -4px;
			border-radius: inherit;
			background: radial-gradient(rgba(255, 255, 255, 0.4), transparent 65%);
			filter: blur(8px);
			opacity: 0.35;
			pointer-events: none;
		}
		.progress__fill {
			position: absolute;
			inset: 0;
			width: 0;
			border-radius: inherit;
			background: linear-gradient(90deg, #125c91 0%, #31d1e3 100%);
			box-shadow: 0 0 20px rgba(79, 213, 255, 0.8);
			transition: width 5s cubic-bezier(.25,.8,.25,1);
		}
		.progress__runner {
			position: absolute;
			top: 50%;
			left: 0;
			width: 80px;
			height: 80px;
			transform: translateY(-50%) translateX(var(--runner-x, -18px)) scaleX(-1);
			transition: transform 5s cubic-bezier(.25,.8,.25,1);
		}
		.progress__runner img {
			width: 100%;
			height: 100%;
			object-fit: contain;
			pointer-events: none;
		}
		.snow,
		.snow::before,
		.snow::after {
			position: fixed;
			inset: -10% 0;
			pointer-events: none;
			background-image:
				radial-gradient(circle, rgba(255, 255, 255, 0.9) 2px, transparent 3px),
				radial-gradient(circle, rgba(255, 255, 255, 0.5) 1.5px, transparent 3px),
				radial-gradient(circle, rgba(255, 255, 255, 0.7) 2px, transparent 3px);
			background-size: 240px 240px, 320px 320px, 180px 180px;
			background-repeat: repeat;
			mix-blend-mode: screen;
		}
		.snow {
			z-index: 2;
			opacity: 0.55;
			animation: snow-fall 26s linear infinite;
		}
		.snow::before,
		.snow::after {
			content: "";
			opacity: 0.35;
			animation: snow-fall 36s linear infinite, snow-drift 7s ease-in-out infinite alternate;
		}
		.snow::after {
			opacity: 0.25;
			animation-duration: 48s, 10s;
		}
		@keyframes snow-fall {
			from { background-position: 0 0, 0 0, 0 0; }
			to { background-position: 0 320px, 0 480px, 0 640px; }
		}
		@keyframes snow-drift {
			from { transform: translateX(-25px); }
			to { transform: translateX(25px); }
		}
		@keyframes snow-glow {
			from {
				transform: translateY(0);
			}
			to {
				transform: translateY(14px);
			}
		}
		@keyframes runner-bob {
			from { transform: translateY(0); }
			to { transform: translateY(-4px); }
		}
		@keyframes runner-steps {
			from { transform: translate(-50%, 0) skewX(-6deg); }
			to { transform: translate(-50%, 2px) skewX(6deg); }
		}
		@keyframes runner-move {
			from { transform: translateY(-50%) translateX(-18px); }
			to { transform: translateY(-50%) translateX(var(--runner-end-x)); }
		}
		@keyframes limb-swing {
			from { transform: rotate(-12deg); }
			to { transform: rotate(14deg); }
		}
		.audio-toggle {
			position: fixed;
			right: clamp(16px, 4vw, 32px);
			bottom: clamp(16px, 4vw, 32px);
			padding: 0.75rem 1.5rem;
			border: none;
			border-radius: 999px;
			font-weight: 600;
			color: #041123;
			background: rgba(255, 255, 255, 0.85);
			box-shadow: 0 12px 30px rgba(0, 0, 0, 0.35);
			cursor: pointer;
		}
		.audio-toggle[hidden] {
			display: none;
		}
		#bg-audio {
			position: fixed;
			width: 1px;
			height: 1px;
			opacity: 0;
			pointer-events: none;
		}
		.countdown {
			position: fixed;
			left: 50%;
			bottom: clamp(16px, 2vh, 64px);
			transform: translateX(-50%);
			width: min(360px, 78vw);
			padding: clamp(0.75rem, 1.5vw, 1.1rem) clamp(1rem, 3vw, 2rem);
			border-radius: clamp(20px, 4vw, 30px);
			background: rgba(8, 20, 46, 0.78);
			backdrop-filter: blur(12px);
			border: 3px solid rgba(255, 255, 255, 0.15);
			box-shadow: 0 12px 30px rgba(0, 0, 0, 0.45), 0 0 38px rgba(255, 215, 0, 0.28);
			display: flex;
			justify-content: center;
			z-index: 2;
		}
		.countdown::before {
			content: "";
			position: absolute;
			inset: 22%;
			border-radius: inherit;
			background: radial-gradient(circle, rgba(255, 255, 255, 0.25), transparent 65%);
			filter: blur(9px);
			pointer-events: none;
		}
		.countdown__timer {
			display: flex;
			align-items: center;
			font-family: "Aldrich", "Segoe UI", system-ui, sans-serif;
			gap: clamp(0.35rem, 1.5vw, 1rem);
		}
		.countdown__value {
			font-size: clamp(2rem, 6vw, 3.25rem);
			font-weight: 600;
			line-height: 1;
			background: linear-gradient(120deg, #fff6a9, #ffd66d, #fff);
			-webkit-background-clip: text;
			color: transparent;
			text-shadow: 0 0 14px rgba(255, 196, 53, 0.75);
			animation: countdown-shimmer 4s linear infinite;
			min-width: 2ch;
			text-align: center;
		}
		.countdown__separator {
			font-size: clamp(1.5rem, 4vw, 3rem);
			color: rgba(255, 255, 255, 0.55);
			animation: countdown-glow 1.2s ease-in-out infinite alternate;
		}
		.countdown--arrived {
			background: linear-gradient(120deg, rgba(255, 196, 53, 0.9), rgba(255, 115, 92, 0.9));
			box-shadow: 0 20px 55px rgba(0, 0, 0, 0.5), 0 0 65px rgba(255, 255, 255, 0.5);
		}
		@keyframes countdown-shimmer {
			0% { background-position: 0% 50%; }
			100% { background-position: 200% 50%; }
		}
		@keyframes countdown-glow {
			from { opacity: 0.4; }
			to { opacity: 1; }
		}
	</style>
</head>
<body>
	<div class="snow" aria-hidden="true"></div>
	<div class="scene">
		<img class="scene__bg" src="./0done.jpg" alt="Festive scene with a Christmas tree" />
		<button class="tree-star-hotspot" type="button" aria-label="Ô±ÕµÕ½ Õ¿Õ¡Ö€Õ« Õ´Õ«Õ¡Õ½Õ¶Õ¡Õ¯Õ¡Õ¶ Õ¸Ö‚ÕªÕ¥Ö€Õ¸Õ¾ Õ¯Õ¾Õ¡Õ¼Õ¥Õ¶Ö„ Õ¿Õ¸Õ¶Õ¡Õ®Õ¡Õ¼Õ« Õ¬Õ¸Ö‚ÕµÕ½Õ¥Ö€Õ¨"></button>
		<div class="tree-toy" role="img" aria-label="Christmas tree ornament" data-hover-text="Ô¹Õ¸Õ² Õ¸Ö€ Õ£Õ¡Õ¬Õ«Ö„ Õ¿Õ¡Ö€Õ¸Ö‚Õ´ Õ¬Õ«Õ¶Õ¥Õ¶Ö„ Õ¡Õ¼Õ¡Õ¾Õ¥Õ¬ Õ°Õ¥Õ¿Õ¡Ö„Ö€Ö„Ö€Õ¡Õ½Õ¥Ö€, Õ¡ÕµÕ¶ Õ¡ÕºÕ¡Õ°Õ¸Õ¾Õ¸Ö‚Õ´ Õ§ Õ·Õ¡Ö€Õ¸Ö‚Õ¶Õ¡Õ¯Õ¡Õ¯Õ¡Õ¶ Õ¦Õ¡Ö€Õ£Õ¡ÖÕ¸Ö‚Õ´ ðŸŽ„" data-x="0.35" data-y="0.78" data-size-ratio="0.08" data-glow-color="#ffd97d" data-glow-intensity="0.8">
			<span class="tree-toy__glow" aria-hidden="true"></span>
			<img src="./toys/mane.png" alt="Glass tree ornament" loading="lazy" />
		</div>
        <div class="tree-toy" role="img" aria-label="Christmas tree ornament" data-hover-text="Ô¹Õ¸Õ² 2026 Õ©Õ¾Õ¡Õ¯Õ¡Õ¶Õ¨ Õ¬Õ«Õ¶Õ« Õ¶Õ¸Ö€ Õ°Õ¶Õ¡Ö€Õ¡Õ¾Õ¸Ö€Õ¸Ö‚Õ©ÕµÕ¸Ö‚Õ¶Õ¶Õ¥Ö€Õ«, Õ¡Õ¶Õ½ÕºÕ¡Õ¼ Õ§Õ¶Õ¥Ö€Õ£Õ«Õ¡ÕµÕ« Ö‡ Õ´Õ¥Õ® Õ±Õ¥Õ¼Ö„Õ¢Õ¥Ö€Õ¸Ö‚Õ´Õ¶Õ¥Ö€Õ« Õ¿Õ¡Ö€Õ« â¤ï¸âœ¨ï¸" data-x="0.5" data-y="0.5" data-size-ratio="0.08" data-glow-color="#ffffff" data-glow-intensity="0.8">
            <span class="tree-toy__glow" aria-hidden="true"></span>
            <img src="./toys/sofi.png" alt="Glass tree ornament" loading="lazy" />
        </div>
        <div class="tree-toy" role="img" aria-label="Christmas tree ornament" data-hover-text="Õ‘Õ¡Õ¶Õ¯Õ¡Õ¶Õ¸Ö‚Õ´ Õ¥Õ´ 2026-Õ¨ Õ¬Õ«Õ¶Õ« Õ­Õ¡Õ²Õ¡Õ²Õ¸Ö‚Õ©ÕµÕ¡Õ¶, Õ¥Ö€Õ»Õ¡Õ¶Õ¯Õ¸Ö‚Õ©ÕµÕ¡Õ¶ Ö‡ Õ¡Õ¼Õ¸Õ²Õ»Õ¸Ö‚Õ©ÕµÕ¡Õ¶ Õ¿Õ¡Ö€Õ«ðŸ’š" data-x="0.4" data-y="0.6" data-size-ratio="0.08" data-glow-color="#39d0ff" data-glow-intensity="0.8">
            <span class="tree-toy__glow" aria-hidden="true"></span>
            <img src="./toys/valodya.png" alt="Glass tree ornament" loading="lazy" />
        </div>
        <div class="tree-toy" role="img" aria-label="Christmas tree ornament" data-hover-text="Õ†Õ¸Ö€ Õ¿Õ¡Ö€Õ«Õ¶ Õ©Õ¸Õ² Õ¬Õ«Õ¶Õ« Õ¡ÕµÕ¶ Õ¯Õ¥Õ¿Õ¨, Õ¸Ö€Õ¿Õ¥Õ² Õ£Õ¡Õ²Õ¡ÖƒÕ¡Ö€Õ¶Õ¥Ö€Õ¨ Õ¤Õ¡Õ¼Õ¶Õ¸Ö‚Õ´ Õ¥Õ¶ Õ£Õ¸Ö€Õ®,Õ±Õ¡ÕµÕ¶Õ¨Õ Õ¡Õ¦Õ¤Õ¥ÖÕ¸Ö‚Õ©ÕµÕ¸Ö‚Õ¶,Õ«Õ½Õ¯ Õ¥Ö€Õ«Õ¿Õ¡Õ½Õ¡Ö€Õ¤Õ¸Ö‚Õ©ÕµÕ¸Ö‚Õ¶Õ¨Õ Õ«Ö€Õ¡Õ¯Õ¡Õ¶ ÖƒÕ¸ÖƒÕ¸Õ­Õ¸Ö‚Õ©ÕµÕ¡Õ¶ Õ¸Ö‚ÕªÖ‰" data-x="0.6" data-y="0.7" data-size-ratio="0.08" data-glow-color="#7fe067" data-glow-intensity="0.8">
            <span class="tree-toy__glow" aria-hidden="true"></span>
            <img src="./toys/sveta.png" alt="Glass tree ornament" loading="lazy" />
        </div>
        <div class="tree-toy" role="img" aria-label="Christmas tree ornament" data-hover-text="Ô¹Õ¸Õ² Õ¸Ö€ Õ´ÕµÕ¸Ö‚Õ½ Õ¿Õ¡Ö€Õ« Õ¢Õ¸Õ¬Õ¸Ö€ Õ»Õ¸Õ¯Õ¡Õ¿Õ¶Õ¥Ö€Õ¨ Ô½Õ¡Õ²Õ¡ÕµÕ¶Õ¡ÖÕ´Õ¡Õ¶ Õ»Õ¸Õ¯Õ¡Õ¿Õ« ÕºÕ¥Õ½ Õ¬Õ¡Õ¾ Õ¡Õ·Õ­Õ¡Õ¿Õ¥Õ¶ ðŸ˜‰ðŸ˜œ" data-x="0.57" data-y="0.57" data-size-ratio="0.065" data-glow-color="#ff8bdc" data-glow-intensity="0.8">
            <span class="tree-toy__glow" aria-hidden="true"></span>
            <img src="./toys/artur.png" alt="Glass tree ornament" loading="lazy" />
        </div>
        <div class="tree-toy" role="img" aria-label="Christmas tree ornament" data-hover-text="Ô¹Õ¸Õ² 2025 Õ©Õ¾Õ¡Õ¯Õ¡Õ¶Õ¨ Õ¬Õ«Õ¶Õ« Õ¢Õ¸Õ¬Õ¸Ö€Õ«Õ½ Õ±Õ¡Õ­Õ¸Õ²Õ¸Ö‚Õ´Õ¶Õ¥Ö€Õ« Õ¾Õ¥Ö€Õ»Õ«Õ¶ Õ¿Õ¡Ö€Õ«Õ¶ âœ¨" data-x="0.42" data-y="0.45" data-size-ratio="0.067" data-glow-color="#ffa64d" data-glow-intensity="0.8">
            <span class="tree-toy__glow" aria-hidden="true"></span>
            <img src="./toys/hamo.png" alt="Glass tree ornament" loading="lazy" />
        </div>
        <div class="tree-toy" role="img" aria-label="Christmas tree ornament" data-hover-text="Ô¹Õ¸Õ² Õ´ÕµÕ¸Ö‚Õ½ Õ¿Õ¡Ö€Õ« Õ´Õ¡Ö€Õ¤Õ«Õ¯ Õ¹ÖƒÕ¸Õ·Õ´Õ¡Õ¶Õ¥Õ¶ Õ«Ö€Õ¥Õ¶Ö Õ¸Ö€Õ¸Õ·Õ¸Ö‚Õ´Õ¶Õ¥Ö€Õ« Õ°Õ¡Õ´Õ¡Ö€" data-x="0.5" data-y="0.67" data-size-ratio="0.08" data-glow-color="#998b8e" data-glow-intensity="0.8">
            <span class="tree-toy__glow" aria-hidden="true"></span>
            <img src="./toys/erik.png" alt="Glass tree ornament" loading="lazy" />
        </div>
        <div class="tree-toy" role="img" aria-label="Christmas tree ornament" data-hover-text="Ô¹Õ¸Õ² Õ´ÕµÕ¸Ö‚Õ½ Õ¿Õ¡Ö€Õ« Ô±Ö€Õ½Õ¥Õ¶Õ¶ Õ¸Ö‚ ÕŒÕ«Õ´Õ¡Õ¶ Õ¶Õ¸Ö‚ÕµÕ¶ Õ¹Õ¡Öƒ Õ§Õ¶Õ¿Õ¸Ö‚Õ¦Õ«Õ¡Õ¦Õ´Õ¸Õ¾ Ö‡ Õ½Õ«Ö€Õ¸Õ¾ Õ´Ö€ÖÕ¡Õ¯ÖÕ¥Õ¶ ðŸŽ„" data-x="0.53" data-y="0.4" data-size-ratio="0.08" data-glow-color="#02f7eb" data-glow-intensity="0.8">
            <span class="tree-toy__glow" aria-hidden="true"></span>
            <img src="./toys/abo.png" alt="Glass tree ornament" loading="lazy" />
        </div>
		<div class="progress" aria-live="polite">
			<div class="progress__track">
				<span class="progress__fill"></span>
				<span class="progress__runner">
					<img src="./runner.gif" alt="Runner" loading="lazy" />
				</span>
			</div>
		</div>
	</div>
	<div class="countdown" role="timer" aria-label="Countdown to January 1, 2026">
		<div class="countdown__timer" aria-live="polite">
			<span class="countdown__value" data-part="hours">00</span>
			<span class="countdown__separator">:</span>
			<span class="countdown__value" data-part="minutes">00</span>
			<span class="countdown__separator">:</span>
			<span class="countdown__value" data-part="seconds">00</span>
		</div>
	</div>
	<audio id="bg-audio" preload="auto">
		<source src="./songs/song1.mp3" type="audio/mpeg" />
        <source src="./songs/song2.mp3" type="audio/mpeg" />
        <source src="./songs/song3.mp3" type="audio/mpeg" />
        <source src="./songs/song4.mp3" type="audio/mpeg" />
        <source src="./songs/song5.mp3" type="audio/mpeg" />
        <source src="./songs/song6.mp3" type="audio/mpeg" />
        <source src="./songs/song7.mp3" type="audio/mpeg" />
        <source src="./songs/song8.mp3" type="audio/mpeg" />
        <source src="./songs/song9.mp3" type="audio/mpeg" />
	</audio>
	<script>
		const scene = document.querySelector(".scene");
		const img = document.querySelector(".scene__bg");
		const star = document.querySelector(".tree-star-hotspot");
		const toys = Array.from(document.querySelectorAll(".tree-toy"));
		const track = document.querySelector(".progress__track");
		const fill = document.querySelector(".progress__fill");
		const runners = document.querySelectorAll(".progress__runner");
		const progressLabel = document.querySelector(".progress__meta strong");
		const audioPlayer = document.getElementById("bg-audio");
		const AUDIO_PROMPT_CLASS = "needs-audio";
		const PROGRESS_RATIO = 0.66;
		const RUNNER_RESET = -18;
		const RUNNER_AHEAD_OFFSET = 20;
		const STAR_X = 0.735;
		const STAR_Y = 0.225;
		const DEFAULT_TOY_RATIO = 0.08;
		const toyWidthRatios = new WeakMap();
		const MIN_GLOW_INTENSITY = 0.15;
		const MAX_GLOW_INTENSITY = 0.85;
		const TARGET_DATE = Date.UTC(2025, 11, 31, 20, 0, 0, 0);
		const countdownRefs = {
			wrapper: document.querySelector(".countdown"),
			hours: document.querySelector('[data-part="hours"]'),
			minutes: document.querySelector('[data-part="minutes"]'),
			seconds: document.querySelector('[data-part="seconds"]')
		};
		const formatTimeUnit = (value) => String(value).padStart(2, "0");

		const updateAnchoredElements = () => {
			if (!scene || !img || !img.naturalWidth || !img.naturalHeight) return;
			const rect = scene.getBoundingClientRect();
			const scale = Math.max(rect.width / img.naturalWidth, rect.height / img.naturalHeight);
			const displayWidth = img.naturalWidth * scale;
			const displayHeight = img.naturalHeight * scale;
			const offsetX = (displayWidth - rect.width) / 2;
			const offsetY = (displayHeight - rect.height) / 2;
			const anchor = (el, xRatio, yRatio, topVar, leftVar) => {
				if (!el) return;
				const x = xRatio * displayWidth - offsetX;
				const y = yRatio * displayHeight - offsetY;
				el.style.setProperty(leftVar, `${(x / rect.width) * 100}%`);
				el.style.setProperty(topVar, `${(y / rect.height) * 100}%`);
			};
			anchor(star, STAR_X, STAR_Y, "--star-top", "--star-left");
			toys.forEach((toy) => {
				const xRatio = Number.parseFloat(toy.dataset.x ?? "");
				const yRatio = Number.parseFloat(toy.dataset.y ?? "");
				const safeX = Number.isFinite(xRatio) ? xRatio : 0.5;
				const safeY = Number.isFinite(yRatio) ? yRatio : 0.5;
				anchor(toy, safeX, safeY, "--toy-top", "--toy-left");

				let ratio = Number.parseFloat(toy.dataset.sizeRatio ?? "");
				if (!Number.isFinite(ratio) || ratio <= 0) {
					ratio = toyWidthRatios.get(toy);
					if (!ratio) {
						const measuredWidth = toy.getBoundingClientRect().width;
						if (measuredWidth > 0 && displayWidth > 0) {
							ratio = measuredWidth / displayWidth;
							toyWidthRatios.set(toy, ratio);
						}
					}
				}

				toy.style.setProperty("--toy-size", `${displayWidth * (ratio || DEFAULT_TOY_RATIO)}px`);
				applyToyGlowCustomization(toy);
			});
		};
		const clamp = (value, min, max) => Math.min(max, Math.max(min, value));
		const hexToRgb = (hex) => {
			const normalized = hex?.trim().replace(/^#/, "");
			if (!normalized || !/^[0-9a-f]{3}([0-9a-f]{3})?$/i.test(normalized)) return null;
			const full = normalized.length === 3 ? normalized.replace(/./g, (ch) => ch + ch) : normalized;
			const intVal = Number.parseInt(full, 16);
			return { r: (intVal >> 16) & 255, g: (intVal >> 8) & 255, b: intVal & 255 };
		};
		const mixChannel = (channel, target, factor) => Math.round(channel + (target - channel) * factor);
		const lighten = (rgb, factor = 0.35) => ({
			r: mixChannel(rgb.r, 255, factor),
			g: mixChannel(rgb.g, 255, factor),
			b: mixChannel(rgb.b, 255, factor)
		});
		const darken = (rgb, factor = 0.15) => ({
			r: mixChannel(rgb.r, 0, factor),
			g: mixChannel(rgb.g, 0, factor),
			b: mixChannel(rgb.b, 0, factor)
		});
		const formatRgb = (rgb) => `${rgb.r}, ${rgb.g}, ${rgb.b}`;
		const applyToyGlowCustomization = (toy) => {
			const baseColor = hexToRgb(toy.dataset.glowColor ?? "");
			if (baseColor) {
				toy.style.setProperty("--toy-glow-color-rgb", formatRgb(lighten(baseColor)));
				toy.style.setProperty("--toy-glow-color-mid-rgb", formatRgb(darken(baseColor, 0.1)));
			}
			const intensity = Number.parseFloat(toy.dataset.glowIntensity ?? "");
			if (Number.isFinite(intensity)) {
				toy.style.setProperty("--toy-glow-strength", clamp(intensity, MIN_GLOW_INTENSITY, MAX_GLOW_INTENSITY));
			}
		};
		const updateProgressVisuals = () => {
			if (!track || !fill || !runners.length) return;
			const runner = runners[0];
			const trackWidth = track.offsetWidth;
			const targetPx = trackWidth * PROGRESS_RATIO;
			const runnerTarget = Math.max(RUNNER_RESET, targetPx - RUNNER_AHEAD_OFFSET);

			fill.style.width = "0%";
			runner.style.setProperty("--runner-x", `${RUNNER_RESET}px`);

			requestAnimationFrame(() => {
				requestAnimationFrame(() => {
					fill.style.width = `${PROGRESS_RATIO * 100}%`;
					runner.style.setProperty("--runner-x", `${runnerTarget}px`);
				});
			});

			if (progressLabel) progressLabel.textContent = `${Math.round(PROGRESS_RATIO * 100)}%`;
		};

		const getAvailableTracks = () => {
			if (!audioPlayer) return [];
			const playlistData = audioPlayer.dataset.playlist;
			if (playlistData) {
				try {
					const parsed = JSON.parse(playlistData);
					if (Array.isArray(parsed) && parsed.length) return parsed.filter(Boolean);
				} catch (error) {
					console.warn("Invalid playlist data:", error);
				}
			}
			return Array.from(audioPlayer.querySelectorAll("source"))
				.map((source) => source.getAttribute("src"))
				.filter(Boolean);
		};

		const playRandomSong = (forceNewTrack = false) => {
			if (!audioPlayer) return;
			const playlist = getAvailableTracks();
			if (!playlist.length) return;
			if (!audioPlayer.getAttribute("src") || forceNewTrack) {
				const randomTrack = playlist[Math.floor(Math.random() * playlist.length)];
				audioPlayer.src = randomTrack;
			}
			audioPlayer.currentTime = 0;
			audioPlayer.play()
				.then(() => {
					audioPlayer.removeAttribute("controls");
					star?.classList.remove(AUDIO_PROMPT_CLASS);
				})
				.catch(() => {
					audioPlayer.setAttribute("controls", "controls");
					star?.classList.add(AUDIO_PROMPT_CLASS);
				});
		};

		const attachToyHoverEffects = () => {
			toys.forEach((toy) => {
				const toySprite = toy.querySelector("img");
				const toyGlow = toy.querySelector(".tree-toy__glow");
				const swingTargets = [toySprite, toyGlow].filter((node) => node && typeof node.animate === "function");
				if (!swingTargets.length) return;

				let toySwingAnimations;
				let toyRateTweenHandle;

				const ensureToySwing = () => {
					if (!toySwingAnimations) {
						toySwingAnimations = swingTargets.map((target) => {
							const frames = target === toyGlow
								? [
										{ transform: "translate(-50%, -50%) rotate(-6deg)" },
										{ transform: "translate(-50%, -50%) rotate(6deg)" }
									]
								: [
										{ transform: "rotate(-6deg)" },
										{ transform: "rotate(6deg)" }
									];
							return target.animate(frames, {
								duration: 2000,
								direction: "alternate",
								easing: "ease-in-out",
								iterations: Infinity,
								fill: "both"
							});
						});
					}
					return toySwingAnimations;
				};

				const tweenToyRate = (targetRate = 1) => {
					const animations = ensureToySwing() ?? [];
					if (!animations.length) return;
					if (toyRateTweenHandle) cancelAnimationFrame(toyRateTweenHandle);

					const startRate = animations[0].playbackRate || 1;
					const startTime = performance.now();
					const duration = 260;

					const tick = (now) => {
						const progress = Math.min(1, (now - startTime) / duration);
						const eased = progress * (2 - progress);
						const nextRate = startRate + (targetRate - startRate) * eased;
						animations.forEach((animation) => (animation.playbackRate = nextRate));

						if (progress < 1) {
							toyRateTweenHandle = requestAnimationFrame(tick);
						} else {
							animations.forEach((animation) => (animation.playbackRate = targetRate));
							toyRateTweenHandle = null;
						}
					};

					toyRateTweenHandle = requestAnimationFrame(tick);
				};

				ensureToySwing();
				toy.addEventListener("pointerenter", () => tweenToyRate(2.1));
				toy.addEventListener("pointerleave", () => tweenToyRate(1));
			});
		};

		star?.addEventListener("click", () => playRandomSong(true));
		attachToyHoverEffects();

		const initializeScene = () => {
			updateAnchoredElements();
			updateProgressVisuals();
		};

		const updateCountdownTimer = () => {
			if (!countdownRefs.wrapper) return true;
			const diffSeconds = Math.max(0, Math.floor((TARGET_DATE - Date.now()) / 1000));
			const totalHours = Math.floor(diffSeconds / 3600);
			const minutes = Math.floor((diffSeconds % 3600) / 60);
			const seconds = diffSeconds % 60;

			countdownRefs.hours.textContent = formatTimeUnit(totalHours);
			countdownRefs.minutes.textContent = formatTimeUnit(minutes);
			countdownRefs.seconds.textContent = formatTimeUnit(seconds);



			if (diffSeconds === 0) {
				countdownRefs.wrapper.classList.add("countdown--arrived");
				return true;
			}

			countdownRefs.wrapper.classList.remove("countdown--arrived");
			return false;
		};

		if (img.complete) {
			initializeScene();
		} else {
			img.addEventListener("load", initializeScene, { once: true });
		}

		window.addEventListener("resize", initializeScene);
		window.addEventListener("load", () => playRandomSong());

		updateCountdownTimer();
		const countdownInterval = setInterval(() => {
			if (updateCountdownTimer()) clearInterval(countdownInterval);
		}, 1000);
	</script>
</body>
</html>